<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lumina Pro Master</title>
    <style>
        :root {
            --bg: #0f172a;
            --sidebar: #1e293b;
            --accent: #3b82f6;
            --text: #f1f5f9;
        }

        body {
            margin: 0;
            font-family: sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: #1e293b;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        aside {
            width: 320px;
            background: #1e293b;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #334155;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        input,
        select {
            width: 100%;
            background: #0f172a;
            color: white;
            border: 1px solid #334155;
            padding: 8px;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .preview-area {
            flex: 1;
            background: #020617;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #canvasContainer {
            position: relative;
            display: none;
        }

        #imagePreview {
            max-height: 80vh;
            max-width: 100%;
            border: 1px solid #334155;
        }

        #movableText {
            position: absolute;
            cursor: move;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            white-space: nowrap;
            pointer-events: auto;
        }

        #cropOverlay {
            position: absolute;
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            display: none;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <header>
        <div style="font-weight: bold; font-size: 20px;">LUMINA <span style="color:#3b82f6">MASTER</span></div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#475569; color:white; width:auto; padding: 8px 15px;"
                onclick="undo()">Undo</button>
            <button class="btn" style="background:#10b981; color:white; width:auto; padding: 8px 15px;"
                onclick="sendRequest('download')">Download HD</button>
        </div>
    </header>

    <main>
        <aside>
            <div class="control-group">
                <label>1. Upload</label>
                <input type="file" id="uploadInput">
            </div>

            <div class="control-group">
                <button id="cropBtn" onclick="toggleCrop()" class="btn" style="background:#f59e0b; color:white;">Crop
                    Mode: OFF</button>
                <label>2. Filters</label>
                <select id="filterSelect" onchange="sendRequest('preview')">
                    <option value="none">Normal</option>
                    <option value="grayscale">Grayscale</option>
                    <option value="sepia">Sepia</option>
                    <option value="invert">Invert</option>
                </select>
            </div>

            <div class="control-group">
                <label>3. Adjustments</label>
                <label style="font-size:10px">Brightness</label><input type="range" id="brightness" min="0" max="2"
                    step="0.1" value="1" onchange="sendRequest('preview')">
                <label style="font-size:10px">Contrast</label><input type="range" id="contrast" min="0" max="2"
                    step="0.1" value="1" onchange="sendRequest('preview')">
            </div>

            <div class="control-group" style="border-top: 1px solid #334155; padding-top:15px;">
                <label>4. Typography</label>
                <input type="text" id="textInput" placeholder="Add text..." oninput="updateText()">
                <label style="margin-top:10px; font-size:10px">Size & Color</label>
                <input type="range" id="textSize" min="10" max="200" value="40" oninput="updateText()">
                <input type="color" id="textColor" value="#FFFFFF" onchange="updateText(); saveState()">
            </div>
            <button onclick="sendRequest('preview')" class="btn" style="background:white; color:black;">Force
                Refresh</button>
        </aside>

        <section class="preview-area" id="dropZone">
            <p id="msg">Upload image to begin</p>
            <div id="canvasContainer">
                <img id="imagePreview">
                <div id="cropOverlay"></div>
                <div id="movableText" style="top: 20%; left: 20%; font-size: 40px;">Your Text</div>
            </div>
        </section>
    </main>

    <script>
        let history = [], isAuto = false, isDragging = false, offset = { x: 0, y: 0 };
        let cropMode = false, cropStart = null, cropData = null;
        const movText = document.getElementById('movableText');
        const imgPre = document.getElementById('imagePreview');
        const canvasCont = document.getElementById('canvasContainer');
        const cropOverlay = document.getElementById('cropOverlay');

        function saveState() {
            const state = { b: document.getElementById('brightness').value, c: document.getElementById('contrast').value, f: document.getElementById('filterSelect').value, t: document.getElementById('textInput').value, ts: document.getElementById('textSize').value, tc: document.getElementById('textColor').value, tx: movText.style.left, ty: movText.style.top, cd: cropData };
            history.push(JSON.stringify(state));
        }

        async function sendRequest(mode) {
            const file = document.getElementById('uploadInput').files[0];
            if (!file) return;
            const fd = new FormData();
            fd.append('image', file); fd.append('mode', mode);
            ['filterSelect', 'brightness', 'contrast', 'textInput', 'textSize', 'textColor'].forEach(id => {
                fd.append(id.replace('Select', '').replace('Input', ''), document.getElementById(id).value);
            });
            fd.append('text_x', parseFloat(movText.style.left) / 100 || 0.2);
            fd.append('text_y', parseFloat(movText.style.top) / 100 || 0.2);
            if (cropData) {
                fd.append('crop_x', cropData.x); fd.append('crop_y', cropData.y);
                fd.append('crop_w', cropData.w); fd.append('crop_h', cropData.h);
            }

            const res = await fetch('/process', { method: 'POST', body: fd });
            if (mode === 'preview') {
                const data = await res.json();
                imgPre.src = 'data:image/png;base64,' + data.image;
                canvasCont.style.display = 'inline-block';
                document.getElementById('msg').style.display = 'none';
                saveState();
            } else {
                const blob = await res.blob();
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = "pro_edit.jpg"; a.click();
            }
        }

        function toggleCrop() {
            cropMode = !cropMode;
            document.getElementById('cropBtn').innerText = cropMode ? "Crop Mode: ON" : "Crop Mode: OFF";
            document.getElementById('cropBtn').style.background = cropMode ? "#ef4444" : "#f59e0b";
            if (!cropMode) { cropOverlay.style.display = 'none'; cropData = null; sendRequest('preview'); }
        }

        canvasCont.onmousedown = (e) => {
            if (cropMode) {
                const rect = canvasCont.getBoundingClientRect();
                cropStart = { x: (e.clientX - rect.left) / rect.width, y: (e.clientY - rect.top) / rect.height };
                cropOverlay.style.display = 'block';
            } else if (e.target === movText) {
                isDragging = true;
                offset.x = e.clientX - movText.getBoundingClientRect().left;
                offset.y = e.clientY - movText.getBoundingClientRect().top;
            }
        };

        window.onmousemove = (e) => {
            const rect = canvasCont.getBoundingClientRect();
            if (cropMode && cropStart) {
                let curX = (e.clientX - rect.left) / rect.width;
                let curY = (e.clientY - rect.top) / rect.height;
                cropData = { x: Math.min(cropStart.x, curX), y: Math.min(cropStart.y, curY), w: Math.abs(curX - cropStart.x), h: Math.abs(curY - cropStart.y) };
                cropOverlay.style.left = (cropData.x * 100) + "%"; cropOverlay.style.top = (cropData.y * 100) + "%";
                cropOverlay.style.width = (cropData.w * 100) + "%"; cropOverlay.style.height = (cropData.h * 100) + "%";
            } else if (isDragging) {
                movText.style.left = ((e.clientX - rect.left - offset.x) / rect.width * 100) + "%";
                movText.style.top = ((e.clientY - rect.top - offset.y) / rect.height * 100) + "%";
            }
        };

        window.onmouseup = () => {
            if (cropMode && cropStart) { cropStart = null; sendRequest('preview'); }
            if (isDragging) { saveState(); isDragging = false; }
        };

        function undo() {
            if (history.length > 1) {
                history.pop();
                const s = JSON.parse(history[history.length - 1]);
                document.getElementById('brightness').value = s.b; document.getElementById('contrast').value = s.c;
                document.getElementById('filterSelect').value = s.f; document.getElementById('textInput').value = s.t;
                document.getElementById('textSize').value = s.ts; document.getElementById('textColor').value = s.tc;
                movText.style.left = s.tx; movText.style.top = s.ty; cropData = s.cd;
                updateText(); sendRequest('preview');
            }
        }

        function updateText() {
            movText.innerText = document.getElementById('textInput').value || "Your Text";
            movText.style.fontSize = document.getElementById('textSize').value + "px";
            movText.style.color = document.getElementById('textColor').value;
        }

        document.getElementById('uploadInput').onchange = () => sendRequest('preview');
    </script>
</body>

</html>